<!DOCTYPE html>
<meta charset='utf-8'>
<style>
    html, body, h1, h2, h3, h4, ul, ol, li, p, a {
        padding: 0;
        border: 0;
        margin: 0;
    }

    body {
        font-family: Helvetica, Arial, sans-serif;
    }

    h1 {
        font-size: 33px;
    }

    .background {
        fill: none;
        pointer-events: all;
        stroke: #aaa;
    }

    .filter {
        position: absolute;
        left: 980px;
        top: 20px;
    }

    .title {
        text-align: center;
        padding: 70px 0 70px 0;
        background-color: #eae8e8;
        margin:20px 0 14px 0;
    }

    .eventTypeSelector {
        width: 200px;
        margin: 0 0 8px 0;
        padding: 4px 1px 8px 1px;
        border-radius: 2px;
        background-color: #eae8e8;
        font-size: 14px;
    }

    .eventOptionSelector {
        margin: 4px 0 0 6px;
    }

    .filterSetting {
        margin: 4px 0 4px 6px;
    }

    .typeHeader {
        border-bottom: 1px solid #bbb;
    }

    .divider {
        border-bottom: 1px solid #bbb;
        padding-bottom: 4px;
    }

    .state {
        stroke: #fff;
        stroke-linejoin: round;
    }

    .state-stroke {
        fill: none;
        stroke: #fff;
        stroke-width: 2px;
        stroke-opacity: 0;
        stroke-linejoin: round;
    }

    .city {
        fill: #fcc;
        stroke: #999;
        fill-opacity: 0.7;
        stroke-opacity: 0.8;
    }

    .city:hover {
        fill: #f88;
        opacity: 1;
    }

    .selectedName, .eventTotalsHeader {
        font-size: 18px;
        font-weight: bold;
    }

    .selectedSummary {
        font-size: 10px;
    }
    
    .axis {
        font-size: 10px;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .eventTotalsXAxis.axis path, .optionXAxis.axis path {
      display: none;
    }

    .optionPct, .totalsText {
        font-size: 10px;
        font-weight: bold;
        fill: #fff;
        opacity: 0;
    }

</style>
<body>
    <main>
        <div class='svg'></div>
        <aside class='filter'>
            <div class='title'>
                <h1>BootLoader</h1>
                <h4>ANALYTICS EXPLORER</h4>
            </div>
            <div class='eventTypeSelector'>
                <div class=typeHeader>
                    <h4>EVENT TYPE</h4>
                </div>
                <input type='checkbox' class='event_name apply eventOptionSelector' data-event_name='View Project'> View Project<span></span><br>
                <input type='checkbox' class='event_name apply eventOptionSelector' data-event_name='Fund Project' checked> Fund Project<span></span><br>
            </div>
            <div class='eventTypeSelector'>
                <div class=typeHeader>
                    <h4>CATEGORY</h4>   
                </div>
                <input type='checkbox' class='category apply eventOptionSelector' data-category='Sports'  > Sports<span></span><br>
                <input type='checkbox' class='category apply eventOptionSelector' data-category='Environment' > Environment<span></span><br>
                <input type='checkbox' class='category apply eventOptionSelector' data-category='Technology' > Technology<span></span><br>
                <input type='checkbox' class='category apply eventOptionSelector' data-category='Fashion' > Fashion<span></span><br>
                <input type='checkbox' class='category apply eventOptionSelector' data-category='Games' > Games<span></span><br>
            </div>
            <div class='eventTypeSelector'>
                <div class=typeHeader>
                    <h4>AGE GROUP</h4>
                </div>
                <input type='checkbox' class='age apply eventOptionSelector' data-age='18-24'  > 18-24<span></span><br>
                <input type='checkbox' class='age apply eventOptionSelector' data-age='25-34' > 25-34<span></span><br>
                <input type='checkbox' class='age apply eventOptionSelector' data-age='35-44' > 35-44<span></span><br>
                <input type='checkbox' class='age apply eventOptionSelector' data-age='45-54' > 45-54<span></span><br>
                <input type='checkbox' class='age apply eventOptionSelector' data-age='55+' > 55+<span></span><br>
            </div>
            <div class='eventTypeSelector'>
                <div class=typeHeader>
                    <h4>MARITAL STATUS</h4>
                </div>
                <input type='checkbox' class='marital_status apply eventOptionSelector' data-marital_status='married'  > Married<span></span><br>
                <input type='checkbox' class='marital_status apply eventOptionSelector' data-marital_status='single' > Single<span></span><br>
            </div>
            <div class='eventTypeSelector'>
                <div class=typeHeader>
                    <h4>GENDER</h4>
                </div>
                <input type='checkbox' class='gender apply eventOptionSelector' data-gender='M' > Male<span></span><br>
                <input type='checkbox' class='gender apply eventOptionSelector' data-gender='F' > Female<span></span><br>
                <input type='checkbox' class='gender apply eventOptionSelector' data-gender='U' > Undeclared<span></span><br>
            </div>
            <div class='eventTypeSelector'>
                <div class=typeHeader>
                    <h4>DEVICE</h4>
                </div>
                <input type='checkbox' class='device apply eventOptionSelector' data-device='android'  > Android<span></span><br>
                <input type='checkbox' class='device apply eventOptionSelector' data-device='iOS' > iOS<span></span><br>
            </div>
            <br>
            <div class='eventTypeSelector'>
                <div class=typeHeader>
                    <h4>FILTER SETTINGS</h4>
                </div>
                <input type='radio' name='metric' value='event_count' checked='true' class='apply filterSetting'/> Event Count
                <br>
                <input type='radio' name='metric' value='event_proportion'class='apply filterSetting'/> Event Percentage of Total
                <br>
                <input type='radio' name='metric' value='funding_amount' class='apply filterSetting'/> Funding Amount
                <br>
                <input type='radio' name='metric' value='funding_proportion'class='apply filterSetting'/> Funding Percentage of Total
                <div class='divider'></div>
                <input type='radio' name='anyOrAll' value='any' checked='true' class='apply filterSetting'/> OR - Match any criteria
                <br>
                <input type='radio' name='anyOrAll' value='all' class='apply filterSetting'/> AND - Match all criteria
                <div class='divider'></div>
                <input type='radio' name='cityOrState' value='city' class='apply filterSetting' checked='true'/> City
                <br>
                <input type='radio' name='cityOrState' value='state' class='apply filterSetting'/> State
                <div class='divider'></div>
                <label for='eventMinSliderValue' class='cityOnly filterSetting'>Minimum Number of Events </label>
                <br>
                <input id='eventMinSliderValue' class='apply cityOnly filterSetting' type='number' min=0 max=200 value=0>
                <input type=range id='eventMinSlider' class='apply cityOnly filterSetting' min='0' value='0' max='200' step='10' list='eventTicks'/>
                <div class='divider '></div>
            </div>
            <datalist id='eventTicks'>
                <option>0</option>
                <option>20</option>
                <option>40</option>
                <option>60</option>
                <option>80</option>
                <option>100</option>
                <option>120</option>
                <option>140</option>
                <option>160</option>
                <option>180</option>
                <option>200</option>
            </datalist>
        </aside>
    </main>
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src='http://d3js.org/queue.v1.min.js'></script>
    <script src='http://d3js.org/topojson.v1.min.js'></script>
    <script>
    
    jQuery(document).ready(function($) {
        var City = function(event) {
            if (!event) return null;
            var city = (!event || !event.location || !event.location.city) ? event.session_id : event.location.city,
                stateCode = (!event || !event.location || !event.location.state) ? event.session_id : event.location.state;
            return {
                name: city + ', ' + stateCode,
                cityName: city, 
                stateCode: stateCode, 
                id: (city + stateCode).replace(/ /g,''),
                longitude: +event.location.longitude,
                latitude: +event.location.latitude,
                eventCount: 0, 
                events: [],
                category: {},
                event_name: {},
                gender: {},
                age: {},
                marital_status: {},
                device: {},
                amount: 0
            };
        }
    
        var State = function(event) {
            var stateCode = (!event || !event.location || !event.location.state) ? event.session_id : event.location.state;
            return {
                name: stateCode,
                stateCode: stateCode, 
                eventCount: 0, 
                events: [], 
                category: {},
                event_name: {},
                gender: {},
                age: {},
                marital_status: {},
                device: {},
                amount: 0
            };
        }

        var width = 960,
            height = 900,
            mapHeight = 600,
            mapMargin = {top: 20, right: 0, bottom: 20, left: 20},
            optionChartHeight = 229,
            optionChartMargin = {top: 48, right: 0, bottom: 80, left: 60},
            eventTotalsHeight = 222,
            eventTotalsMargin = {top: 28, right: 0, bottom: 93, left: 60},
            bootLoaderData,
            cities = [],
            states = [],
            stateTopos = [],
            selectedCity,
            selectedState,
            centered = null,
            initScale = 1200,
            metric =  'event_count',
            cityCircleFactor = 1,
            minCityArea = 8,
            cityTransitionCnt = 0,
            filter = {
                event_name : [],
                category : [],
                age : [],
                marital_status : [],
                gender : [],
                device : []
            },
            eventValues = {
                event_name : ['View Project', 'Fund Project'],
                category : ['Sports', 'Technology', 'Fashion', 'Environment', 'Games'],
                age : ['18-24', '25-34', '35-44', '45-54', '55+'],
                marital_status : ['married', 'single'],
                gender : ['M', 'F', 'U'],
                device : ['android', 'iOS']
            };
                
        var projection = d3.geo.albersUsa()
            .scale(initScale)
            .translate([(width - mapMargin.left - mapMargin.right) / 2, (mapHeight - mapMargin.top - mapMargin.bottom) / 2]);

        var path = d3.geo.path()
            .projection(projection);

        var mapZoom = d3.behavior.zoom()
            .translate(projection.translate())
            .scale(projection.scale())
            .scaleExtent([mapHeight, 15*mapHeight])
            .on("zoom", zoomMap);

        var mapDrag = d3.behavior.drag();

        var maxColor = '#178196',
            minColor = '#BABBAD',
            barColorScale = d3.scale.linear()
                .domain([0, 1])
                .range([minColor, maxColor])
                .interpolate(d3.interpolateHcl);


        var xEventTotals = d3.scale.ordinal()
            .rangeRoundBands([0, width - eventTotalsMargin.left - eventTotalsMargin.right], .1);

        // is backward, so that returns the part that is NOT the bar, i.e., height of chart - height of bar.
        var yEventTotals = d3.scale.linear()
            .rangeRound([eventTotalsHeight - eventTotalsMargin.bottom - eventTotalsMargin.top, 0]);

        var eventTotalsXAxis = d3.svg.axis()
            .scale(xEventTotals)
            .orient('bottom');

        var eventTotalsYAxis = d3.svg.axis()
            .scale(yEventTotals)
            .orient('left')
            .tickFormat(d3.format('.2s'));



        // is backward, so that returns the part that is NOT the bar, i.e., height of chart - height of bar.
        var yOptionBar = d3.scale.linear()
            .rangeRound([optionChartHeight - optionChartMargin.bottom - optionChartMargin.top, 0])
            .domain([0, 1]);

        var optionYAxis = d3.svg.axis()
            .scale(yOptionBar)
            .orient('left')
            .tickFormat(d3.format('%'));



        var svg = d3.select('.svg').append('svg')
            .attr('width', width)
            .attr('height', eventTotalsHeight + mapHeight + optionChartHeight);
        
        var optionChart = svg.append('g')
            .attr('class', 'optionChart')
            .attr('transform', 'translate(0,' + mapMargin.top + ')');

        optionChart.append('text')
            .attr('class', 'selectedName')
            .attr('x', mapMargin.left)
            .attr('y', 16);

        optionChart.append('text')
            .attr('class', 'selectedSummary')
            .attr('x', mapMargin.left)
            .attr('y', 32);

        var mapBox = svg.append("svg")
            .attr('width', width - mapMargin.left - mapMargin.right)
            .attr('height', mapHeight - mapMargin.top - mapMargin.bottom)
            .attr('x', mapMargin.left)
            .attr('y', mapMargin.top + optionChartHeight)
            .attr('width', width - mapMargin.left - mapMargin.right)
            // .attr('transform', 'translate(' + mapMargin.left + ',' + (mapMargin.top + optionChartHeight) + ')')
            .attr('overflow', 'hidden')
            .call(mapZoom)
            .call(mapDrag);

        mapBox.append('rect')
            .attr('width', width - mapMargin.left - mapMargin.right)
            .attr('height', mapHeight - mapMargin.top - mapMargin.bottom)
            .attr('class', 'background');

        var map = mapBox.append("g");
        
        var eventTotalsChart = svg.append('g')
            .attr('class', 'eventTotalsChart')
            .attr('transform', 'translate(0,' + (mapHeight + optionChartHeight) + ')');

        eventTotalsChart.append('text')
            .attr('class', 'eventTotalsHeader')
            .attr('x', mapMargin.left)
            .attr('y', 16);


        queue()
            .defer(d3.json, 'us.json')
            .defer(d3.json, 'data.json')
            .await(ready);

        // bind event minimum inputs
        $('#eventMinSlider').on('change', function() { $('#eventMinSliderValue').val($('#eventMinSlider').val()); })
        $('#eventMinSliderValue').on('change', function() { $('#eventMinSlider').val($('#eventMinSliderValue').val()); })


        function ready(error, us, bootloader) {

            parseData(us, bootloader);

            addMap();

            addOptionBars();

            // filter criteria
            $('.apply').on('click', function() { 
                removeAndApplyFilter(); 
            });

            $('input[type=radio][name=cityOrState]').on('click', function() {
                if ($(this).val() === 'city') {
                    $('.cityOnly').attr('disabled', false);
                } else {
                    $('.cityOnly').attr('disabled', 'disabled');
                }
            });

            applyFilter();
            selectCity(getCityByName('dayton', 'oh'));
        }

        function parseData(us, bootloader) {
            var cityObj = {},
                stateObj = {};

            bootloaderData = bootloader.data;

            // Create an object for each unique city/state combo, and store the event value counts on it.
            bootloaderData.forEach(function(event) {
                var cityState = event.location.city + event.location.state,
                    location = projection([+event.location.longitude, +event.location.latitude]),
                    stateCode = event.location.state;
                if (location) {
                    cityObj[cityState] = cityObj[cityState] || new City(event);
                    cityObj[cityState].eventCount++;
                    cityObj[cityState].amount += event.amount || 0;
                    cityObj[cityState].events.push(event);

                    stateObj[stateCode] = stateObj[stateCode] || new State(event);
                    stateObj[stateCode].eventCount++;
                    stateObj[stateCode].amount += event.amount || 0;
                    stateObj[stateCode].events.push(event);

                    // Options (e.g., category.Sports) become properties of the city and state objects, whose value will be the count of how many times it occurs for a that area.
                    // e.g. if event.category === 'Sports', then increment the vlaue of the category['Sports'] property
                    for (var type in eventValues) {
                        var option = (eventValues[type].indexOf(event[type]) === -1) ? 'undefined' : eventValues[type][eventValues[type].indexOf(event[type])];
                        cityObj[cityState][type][option] = (cityObj[cityState][type][option] || 0) + 1;
                        stateObj[stateCode][type][option] = (stateObj[stateCode][type][option] || 0) + 1;
                    }
                }
            });

            for (var city in cityObj) {
                cities.push(cityObj[city]);
            }

            for (var state in stateObj) {
                states.push(stateObj[state]);
            }
            states.sort(function(a, b) { return getTopoIdByStateCode(a.stateCode, 'id') - getTopoIdByStateCode(b.stateCode, 'id'); });

            // ad states to topo data
            topos = topojson.feature(us, us.objects.states).features;
            topos.forEach(function (stateTopo) {
                var code = getStateByTopoId(stateTopo.id - 1, 'code');
                if (code && stateObj[code]) {
                    stateTopo.state = stateObj[code];
                    stateTopos.push(stateTopo);
                }
            });
        }

        function addMap() {
            // add states to DOM. Use path data from us.json topo data.
            map.append('g')
                .attr('class', 'states')
                .selectAll('path')
                    .data(stateTopos)
                    .enter().append('path')
                    .attr('id', function(d) { return (d.id - 1); })
                    .attr('class', 'state')
                    .attr('fill', minColor)
                    .attr('d', path);


            // state outlines for hover.
            map.append('g')
                .attr('class', 'states-stroke')
                .selectAll('path')
                    .data(stateTopos)
                    .enter().append('path')
                    .attr('id', function(d) { return (d.id - 1); })
                    .attr('class', 'state-stroke')
                    .attr('d', path);
        }

        function addOptionBars() {
            var xOffset = optionChartMargin.left,
                optionCount = 0,
                typeCount = 0,
                margin = 20;

            for (var type in eventValues) {
                typeCount++;
                optionCount += eventValues[type].length;
            }

            optionChart.append('g')
                .attr('class', 'optionYAxis axis')
                .attr('transform', 'translate(' + optionChartMargin.left + ',' + optionChartMargin.top + ')')
                .call(optionYAxis)
                .append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 4)
                    .attr('dy', '.71em')
                    .style('text-anchor', 'end')
                    .text('%')

            for (var type in eventValues) {
                var options = [],
                    optionCounts = [],
                    optionTotal,
                    chartWidth;

                eventValues[type].forEach(function(option) {
                    options.push(option);
                    optionCounts.push(0);
                });
                optionTotal = sum(optionCounts);

                chartWidth = options.length * (width - optionChartMargin.left - optionChartMargin.right - typeCount*margin*2)/optionCount;


                var xOptionBar = d3.scale.ordinal()
                    .rangeRoundBands([0, chartWidth], .1)
                    .domain(options);

                var optionXAxis = d3.svg.axis()
                    .scale(xOptionBar)
                    .orient('bottom');

                optionChart.append('g')
                    .attr('class', 'optionXAxis axis')
                    .attr('transform', 'translate(' + (margin + xOffset) + ',' + (optionChartHeight - optionChartMargin.bottom) + ')')
                    .call(optionXAxis)
                    .selectAll("text")  
                        .style("text-anchor", "end")
                        .attr("dx", "-.8em")
                        .attr("dy", ".15em")
                        .attr("transform", function(d) {
                            return "rotate(-65)" 
                        });

                // mouse event handler
                optionChart.append('g')
                    .selectAll('option.' + type)
                        .data(optionCounts)
                    .enter().append('g')
                        .attr('class', 'option ' + type)
                        .append('rect')
                            .attr('transform', function(d, i) { return 'translate(' + (margin + xOffset + xOptionBar(options[i])) + ',' + optionChartMargin.top + ')'; })
                            .attr('height', optionChartHeight - optionChartMargin.bottom - optionChartMargin.top)
                            .attr('width', xOptionBar.rangeBand())
                            .style('opacity', 0)
                            .on('mouseover', function() {
                                $(this).parent().find('.optionPct').css('opacity', 1)
                            })
                            .on('mouseout', function() {
                               $(this).parent().find('.optionPct').css('opacity', 0)
                            });

                // bars
                d3.selectAll('.option.' + type)
                        .data(optionCounts)
                    .append('rect')
                        .attr('class', 'optionBar ' + type)
                        .attr('transform', function(d, i) { return 'translate(' + (margin + xOffset + xOptionBar(options[i])) + ',' + optionChartMargin.top + ')'; })
                        .attr('width', xOptionBar.rangeBand())
                        .attr('pointer-events', 'none')
                        .style('fill', maxColor);

                // text
                d3.selectAll('.option.' + type)
                        .data(optionCounts)
                    .append('text')
                        .attr('class', 'optionPct ' + type)
                        .attr('pointer-events', 'none')
                        .attr('transform', function(d, i) { 
                            return 'translate(' + (margin + xOffset + xOptionBar(options[i]) + xOptionBar.rangeBand()/2) + ',' + optionChartMargin.top + ')'; 
                        })
                        .style('text-anchor', 'middle')
                        .text('');

                xOffset += (margin*2 + chartWidth);
            }
        }


        function removeAndApplyFilter() {
            metric =  $('input[type=radio][name=metric]:checked').val();
            switch (metric) {
                case 'event_count':
                    cityCircleFactor = 1;
                    break;
                case 'funding_amount':
                    cityCircleFactor = 0.05;
                    break;
                case 'event_proportion':
                case 'funding_proportion':
                    cityCircleFactor = 100;
            }

            map.selectAll('.city').remove();
            applyFilter();
        }

        function applyFilter() {
            // add each selected filter to list
            for (var type in filter) {                          // each type (caegory, age, etc.)
                filter[type].splice(0, filter[type].length);    // delete old items
                $('.' + type + ':checked').each(function() {   // each option within type that is selected (e.g, Sports, Games)
                    filter[type].push($(this).data()[type]);    // filter.category = [Sports, Games]
                });
            }

            if ($('input[type=radio][name=cityOrState]:checked').val() === 'city') {
                applyFilterToCities();
            } else {
                applyFilterToStates();
            }
        }

        function applyFilterToCities() {
            var eventMin = $('#eventMinSliderValue').val(),
                filteredCount,
                sortedCities = [],
                barData = [];

            // put no-zero areas into sorted array, elminating zero-sized cities and layering small above large
            for (var i = 0, l = cities.length; i < l; ++i) {
                filteredCount = getFilteredEventTotals(cities[i]);
                if (filteredCount.count > 0 && cities[i].eventCount >= eventMin) {
                    switch (metric) {
                        case 'event_count':
                            cities[i].area = filteredCount.count;
                            break;
                        case 'event_proportion':
                            cities[i].area = filteredCount.count/cities[i].eventCount;
                            break;
                        case 'funding_amount':
                            cities[i].area = filteredCount.amount;
                            break;
                        case 'funding_proportion':
                            cities[i].area = filteredCount.amount/cities[i].amount || 0;
                    }
                    sortedCities.push(cities[i]);
                    barData.push(cities[i]);
                }
            }
            sortedCities.sort(function(a, b) { return (b.area === a.area) ? b.eventCount - a.eventCount : b.area - a.area; });


            map.append('g')
                .attr('class', 'cities')
                .selectAll('circle')
                    .data(sortedCities)
                .enter().append('svg:circle')
                    .attr('class', 'city')
                    .attr('id', function(d) { return d.id; })
                    .attr('cx', function(d, i) { return projection([d.longitude, d.latitude])[0]; })
                    .attr('cy', function(d, i) { return projection([d.longitude, d.latitude])[1]; })
                    .attr('r', 0)
                    .on('click', selectCity); 

             map.selectAll('circle')
                .transition().duration(400)
                .attr('r', function(d, i) { 
                    return Math.sqrt(Math.max(cityCircleFactor*d.area, minCityArea)); 
                });
                    
            map.selectAll('.state')
                .on('click', null);
            map.selectAll('.state')
                .transition().duration(400)
                .attr('fill', minColor);

            plotTotalsBars(barData);

            selectCity(selectedCity);
        }

        function applyFilterToStates() {
            var barData = [],
                filteredCount;

            states.forEach(function(state) {
                filteredCount = getFilteredEventTotals(state);
                switch (metric) {
                    case 'event_count':
                        state.area = filteredCount.count;
                        break;
                    case 'event_proportion':
                        state.area = filteredCount.count/state.eventCount;
                        break;
                    case 'funding_amount':
                        state.area = filteredCount.amount;
                        break;
                    case 'funding_proportion':
                        state.area = filteredCount.amount/state.amount || 0;
                }
                barData.push(state);
            });


            plotTotalsBars(barData);

            map.selectAll('.state')
                .on('click', function(d) { 
                    selectState(d.state); 
                });
            map.selectAll('.state')
                .transition().duration(400)
                .attr('fill', function(d) { 
                    return barColorScale(d.state.area); 
                });

            selectState(selectedState);
        }


        function plotTotalsBars(barData) {
            var tickFormat,
                label,
                header,
                chartHeight = eventTotalsHeight - eventTotalsMargin.bottom - eventTotalsMargin.top;

            switch (metric) {
                case 'event_count':
                    tickFormat = '.2s';
                    label = 'Events';
                    header = 'Matching Events';
                    break;
                case 'event_proportion':
                    tickFormat = '%';
                    label = '% of Total Events';
                    header = 'Matching Events as Percentage of Total Events';
                    break;
                case 'funding_amount':
                    tickFormat = '$.2s';
                    label = '$';
                    header = 'Matching Event Funding';
                    break;
                case 'funding_proportion':
                    tickFormat = '%';
                    label = '% of Total Funding';
                    header = 'Matching Event Funding as Percentage of Total Funding';
            }

            $('.eventTotalsHeader').text(header); 

            barData.sort(function(a, b) { return (b.area === a.area) ? b.eventCount - a.eventCount : b.area - a.area; });
            barData.splice(51, barData.length - 51);

            xEventTotals.domain(barData.map(function(d) { return d.name; }));
            yEventTotals.domain([0, d3.max(barData, function(d) { return d.area; })]);
            eventTotalsYAxis.tickFormat(d3.format(tickFormat));

            barColorScale.domain([d3.min(barData, function(d) { return d.area; }), d3.max(barData, function(d) { return d.area; })]);

            d3.select('.eventTotalsXAxis').remove();
            d3.select('.eventTotalsYAxis').remove();

            eventTotalsChart.append('g')
                .attr('class', 'eventTotalsXAxis axis')
                .attr('transform', 'translate(' + eventTotalsMargin.left + ',' + (eventTotalsHeight - eventTotalsMargin.bottom) + ')')
                .call(eventTotalsXAxis)
                .selectAll("text")  
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", function(d) {
                        return "rotate(-65)" 
                        });

            eventTotalsChart.append('g')
                .attr('class', 'eventTotalsYAxis axis')
                .attr('transform', 'translate(' + eventTotalsMargin.left + ',' + eventTotalsMargin.top + ')')
                .call(eventTotalsYAxis)
                .append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 4)
                    .attr('dy', '.71em')
                    .style('text-anchor', 'end')
                    .text(label);


            // mouse event handler
            eventTotalsChart.selectAll('.eventTotalsBar')
                .remove();
            eventTotalsChart.append('g')
                .selectAll('.eventTotalsBar')
                    .data(barData)
                .enter().append('g')
                    .attr('class', 'eventTotalsBar')
                    .attr('id', function(d) { return 'TotalsBar' + (d.id || d.stateCode); })
                    .append('rect')
                        .attr('transform', function(d) { return 'translate(' + (eventTotalsMargin.left + xEventTotals(d.name)) + ',' + eventTotalsMargin.top + ')'; })
                        .attr('height', chartHeight)
                        .attr('width', xEventTotals.rangeBand())
                        .style('opacity', 0)
                        .on('mouseover', function(d) {
                            $(this).parent().find('.totalsText').css('opacity', 1);
                            selectMunicipality(d);
                        });

            eventTotalsChart.selectAll('.bar')
                .remove();
            eventTotalsChart.selectAll('.eventTotalsBar')
                    .data(barData)
                .append('rect')
                    .attr('class', 'bar')
                    .attr('pointer-events', 'none')
                    .attr('transform', function(d) { return 'translate(' + (eventTotalsMargin.left + xEventTotals(d.name)) + ',' + eventTotalsMargin.top + ')'; })
                    .attr('width', xEventTotals.rangeBand())
                    .attr('y', function(d) { return yEventTotals(d.area); })
                    .attr('height', function(d) { return chartHeight - yEventTotals(d.area); })
                    .style('fill', function(d) { return barColorScale(d.area); })
                    .on('mouseover', function(d) { selectMunicipality(d); });


            // text
            eventTotalsChart.selectAll('.totalsText')
                .remove();
            eventTotalsChart.selectAll('.eventTotalsBar')
                    .data(barData)
                .append('text')
                    .attr('class', 'totalsText')
                    .attr('pointer-events', 'none')
                    .attr('transform', function(d) { 
                        return 'translate(' + eventTotalsMargin.left + ',' + eventTotalsMargin.top + ')rotate(-90)'; 
                    })
                    .attr('y', function(d) { return xEventTotals(d.name) + 10; })
                    .attr('x', function(d) { 
                        return (chartHeight - yEventTotals(d.area) < 40) ? -yEventTotals(d.area) + 4 : -yEventTotals(d.area) - 4; 
                    })
                    .style('text-anchor', function(d) { 
                        return (chartHeight - yEventTotals(d.area) < 40) ? 'beginning' : 'end' 
                    })
                    .style('fill', function(d) { 
                        return (chartHeight - yEventTotals(d.area) < 40) ? '#000' : '#fff'; 
                    })
                    .text(function(d) { return getTotalsChartDatum(d); });
        }

        function getTotalsChartDatum(municipality) {
            var datum = '';
            switch (metric) {
                case 'event_count':
                    datum = municipality.area;
                    break;
                    break;
                case 'funding_amount':
                    datum = '$' + municipality.area;
                    break;
                case 'funding_proportion':
                case 'event_proportion':
                    datum = getPercentString(municipality.area);
            }
            return datum;
        }

        function plotOptionBars(municipality) {
            var xOffset = optionChartMargin.left,
                optionCount = 0,
                typeCount = 0,
                margin = 20,
                chartHeight = optionChartHeight - optionChartMargin.bottom - optionChartMargin.top;

            for (var type in eventValues) {
                typeCount++;
                optionCount += eventValues[type].length;
            }

            for (var type in eventValues) {
                var options = [],
                    optionCounts = [],
                    optionTotal,
                    chartWidth;

                eventValues[type].forEach(function(option) {
                    options.push(option);
                    optionCounts.push(municipality[type][option] || 0);
                });
                optionTotal = sum(optionCounts);


                chartWidth = options.length * (width - optionChartMargin.left - optionChartMargin.right - typeCount*margin*2)/optionCount;


                var xOptionBar = d3.scale.ordinal()
                    .rangeRoundBands([0, chartWidth], .1)
                    .domain(options);


                optionChart.selectAll('.optionBar.' + type)
                    .data(optionCounts)
                    .transition().duration(400)
                    .attr('y', function(d) { return yOptionBar(d/optionTotal); })
                    .attr('height', function(d) { return chartHeight - yOptionBar(d/optionTotal); });


                optionChart.selectAll('.optionPct.' + type)
                    .data(optionCounts)
                    .transition().duration(400)
                    .attr('y', function(d) { 
                        return (chartHeight - yOptionBar(d/optionTotal) < 14) ? yOptionBar(d/optionTotal) - 2 : yOptionBar(d/optionTotal) + 12; 
                    })
                    .style('fill', function(d) { 
                        return (chartHeight - yOptionBar(d/optionTotal) < 14) ? '#000' : '#fff'; 
                    })
                    // .text(function(d) { return(Math.round(100*d/optionTotal) + '%'); })
                    .text(function(d) { return getPercentString(d/optionTotal); })

                xOffset += (margin*2 + chartWidth);
            }
        }

        function selectMunicipality(muni) {
            if (muni.cityName) {
                selectCity(muni);
            } else {
                selectState(muni);
            }

        }

        function deselectCity() { 
            $('.city')
                .css('fill-opacity', '0.7')
                .css('fill', '#fcc');
        }

        function selectCity(city) { 
            if (!city) return;

            var totals = getFilteredEventTotals(city);
            var filteredCount = totals.count;

            selectedCity = city;
            deselectCity();
            deselectState();

            // totals chart datum
            $('#TotalsBar' + city.id).find('.totalsText').css('opacity', 1);

            // option chart header
            $('.selectedName').text(city.cityName + ', ' + city.stateCode); 
            $('.selectedSummary').text('Total events: ' + city.eventCount 
                + ', Matching events: ' + filteredCount 
                + ' (' + getPercentString(filteredCount/city.eventCount) + ')'
                + ', Total funded amount: $' + city.amount
                + ', Matching event amount: $' + totals.amount
                + ' (' + getPercentString(totals.amount/city.amount) + ')' 
            ); 
 
            $('#' + city.id)
                .css('fill-opacity', '1')
                .css('fill', '#f88');

            plotOptionBars(city);
        }

        function deselectState() { 
            $('.state-stroke').css('stroke-opacity', '0');
            $('.totalsText').css('opacity', '0');
        }

        function selectState(state) { 
            if (!state) return;

            var totals = getFilteredEventTotals(state);
            var filteredCount = totals.count;

            selectedState = state;
            var id = getTopoIdByStateCode(state.stateCode, 'id');

            deselectState();
            $('#' + id + '.state-stroke').css('stroke-opacity', '1');

            // totals chart datum
            $('#TotalsBar' + state.stateCode).find('.totalsText').css('opacity', 1);

            // option chart header
            $('.selectedName').text(getStateByTopoId(id, 'name'));
            $('.selectedSummary').text('Total: ' + state.eventCount 
                + ', Matching: ' + filteredCount 
                + ' (' + getPercentString(filteredCount/state.eventCount) + ')'
                + ', Total funded amount: $' + state.amount
                + ', Matching event amount: $' + totals.amount
                + ' (' + getPercentString(totals.amount/state.amount) + ')' 
            ); 

            plotOptionBars(state);
        }

        function zoomMap() {
            projection.translate(d3.event.translate).scale(d3.event.scale);
            mapBox.selectAll("path").attr("d", path);
            mapBox.selectAll('circle')
                .attr('cx', 
                    function(d, i) { 
                        return projection([d.longitude, d.latitude])[0]; 
                    })
                .attr('cy', function(d, i) { 
                        return projection([d.longitude, d.latitude])[1]; 
                    })
                .attr('r', function(d, i) { 
                    return Math.sqrt(Math.max(cityCircleFactor*d.area, minCityArea)); 
                })
        }

        function getFilteredEventTotals(municipality) {
            // sum the count of events containing at least one of the filter criteria
            var count = 0,
                amount = 0,
                optionFound = false,
                exclusiveZero = ($('input[type=radio][name=anyOrAll]:checked').val() === 'all');

            for (var i = 0, l = municipality.events.length; i < l; ++i) {

                if (exclusiveZero) {
                    // eliminate event if any option not matching
                    optionFound = true;
                    for (var type in filter) {                          // each option type (e.g, category)
                        filter[type].forEach(function(option) {         // each option within type (Sports, Games, etc.)
                            if (municipality.events[i][type] !== option) {
                                optionFound = false;
                            }
                        });
                    }
                    if (optionFound) {        // all options match; count it and go to next event
                        count++;
                        amount += municipality.events[i].amount || 0;
                    }

                } else {
                    // count event if any option matches
                    optionFound = false;
                    for (var type in filter) {                          // each option type (e.g, category)
                        filter[type].forEach(function(option) {         // each option within type (Sports, Games, etc.)
                            if (municipality.events[i][type] === option) {
                                optionFound = true;
                            }
                        });
                        if (optionFound) {        // at least one option matches; count it and go to next event
                            count++;
                            amount += municipality.events[i].amount || 0;
                            break;
                        }
                    }
                }
            }
            return {count: count, amount: amount};
        }


        //
        // Utility
        //
        function sum(obj) {
            var sum = 0;
            if (obj instanceof Array) {
                for (var i = 0, l = obj.length; i < l; ++i) {
                    if (typeof(obj[i]) === 'number') {
                        sum += obj[i];
                    }
                }
            } else {
                for (var prop in obj) {
                    if (typeof(obj[prop]) === 'number') {
                        sum += obj[prop];
                    }
                }
            }
            return sum;
        }

        function getPercentString(amount) {
            return (Math.round(amount*1000)/10 || 0);
        }

        function getMaxOfArray(numArray) {
            return Math.max.apply(null, numArray);
        }
            
        function getMinOfArray(numArray) {
            return Math.min.apply(null, numArray);
        }

        var stateCodes = 
            {code: [
                'AL', 
                'AK', 
                'AS', 
                'AZ', 
                'AR', 
                'CA',
                'xx',
                'CO',
                'CT',
                'DE',
                'DC',
                'FL',
                'GA',
                'GU',
                'HI',
                'ID',
                'IL',
                'IN', 
                'IA',
                'KS',
                'KY',
                'LA',
                'ME',
                'MD',
                'MA',
                'MI',
                'MN',
                'MS',
                'MO',
                'MT',
                'NE',
                'NV',
                'NH',
                'NJ',
                'NM',
                'NY',
                'NC',
                'ND',
                'OH',
                'OK',
                'OR',
                'PA',
                'PR',
                'RI',
                'SC',
                'SD',
                'TN',
                'TX',
                'UT',
                'VT',
                'VA',
                'VI',
                'WA',
                'WV',
                'WI',
                'WY',
            ], 
            name: [
                'Alabama',
                'Alaska',
                'American Samoa',
                'Arizona',
                'Arkansas',
                'California',
                'x',
                'Colorado',
                'Connecticut',
                'Delaware',
                'District Of Columbia',
                'Florida',
                'Georgia',
                'Guam',
                'Hawaii',
                'Idaho',
                'Illinois',
                'Indiana',
                'Iowa',
                'Kansas',
                'Kentucky',
                'Louisiana',
                'Maine',
                'Maryland',
                'Massachusetts',
                'Michigan',
                'Minnesota',
                'Mississippi',
                'Missouri',
                'Montana',
                'Nebraska',
                'Nevada',
                'New Hampshire',
                'New Jersey',
                'New Mexico',
                'New York',
                'North Carolina',
                'North Dakota',
                'Ohio',
                'Oklahoma',
                'Oregon',
                'Pennsylvania',
                'Puerto Rico',
                'Rhode Island',
                'South Carolina',
                'South Dakota',
                'Tennessee',
                'Texas',
                'Utah',
                'Vermont',
                'Virginia',
                'Virgin Islands',
                'Washington',
                'West Virginia',
                'Wisconsin',
                'Wyoming'
            ]
        };
        function getStateByTopoId(index, prop) {
            return (index < stateCodes[prop].length) ? stateCodes[prop][index] : '';
        }

        function getTopoIdByStateCode(code, prop) {
            if (prop && prop.toLowerCase() === 'id') {
                return stateCodes.code.indexOf(code);
            } else {
                return stateCodes.name[stateCodes.code.indexOf(code)];
            }
        }

        function getCityByName(cityName, stateCode) {
            var name = cityName.toLowerCase();
            var state = stateCode.toLowerCase();
            for (var i = 0, l = cities.length; i < l; ++i) {
                if (cities[i].cityName.toLowerCase() === name && cities[i].stateCode.toLowerCase() === state) {
                    return cities[i];
                    break;
                }
            }
            return cities[0];
        }
    });
    </script>
